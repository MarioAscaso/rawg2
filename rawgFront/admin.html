<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin - RAWG</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Estilos espec√≠ficos para la tabla de admin */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: var(--bg-card); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background-color: #2c0e0e; color: var(--danger); }
    </style>
</head>
<body>

    <nav>
        <a href="index.html" style="font-weight:900; font-size:1.5rem;">RAWG ADMIN</a>
        <div style="flex:1"></div>
        <button onclick="localStorage.clear(); window.location.href='login.html';">Salir</button>
    </nav>

    <div class="app-layout">
        <aside id="sidebar-container" class="sidebar"></aside>

        <main class="main-content">
            <h1 style="border-bottom: 2px solid var(--danger);">üõ°Ô∏è Gesti√≥n Usuarios</h1>
            
            <div id="loading-msg">Cargando datos...</div>
            <div id="table-container"></div>
        </main>
    </div>

    <script type="module" src="js/navbar.js"></script>
    <script type="module" src="js/sidebar.js"></script>
    
    <script type="module">
        import { getAllUsersApi, deleteUserApi } from './js/api.js';

        document.addEventListener("DOMContentLoaded", async () => {
            const role = localStorage.getItem('rawg_role');
            if (role !== 'ADMIN') {
                window.location.href = 'index.html'; // Protecci√≥n b√°sica
                return;
            }

            const users = await getAllUsersApi();
            document.getElementById('loading-msg').style.display = 'none';
            const container = document.getElementById('table-container');

            let html = `<table><thead><tr><th>ID</th><th>Usuario</th><th>Email</th><th>Rol</th><th>Acciones</th></tr></thead><tbody>`;
            
            users.forEach(u => {
                const deleteBtn = u.role === 'ADMIN' 
                    ? '<span style="color:#666">Protegido</span>' 
                    : `<button onclick="window.confirmDelete(${u.id}, '${u.username}')" style="background:var(--danger); border:none; color:white; padding:5px 10px; cursor:pointer;">Eliminar</button>`;
                
                html += `<tr>
                    <td>${u.id}</td>
                    <td><strong>${u.username}</strong></td>
                    <td>${u.email || '-'}</td>
                    <td>${u.role}</td>
                    <td>${deleteBtn}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        });

        // Funci√≥n global para el onclick
        window.confirmDelete = async (id, name) => {
            const res = await Swal.fire({
                title: '¬øSeguro?', text: `Borrar a ${name}`, icon: 'warning', showCancelButton: true
            });
            if (res.isConfirmed) {
                await deleteUserApi(id);
                location.reload();
            }
        };
    </script>
</body>
</html>